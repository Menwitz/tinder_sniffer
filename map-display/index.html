<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Map Display</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    html, body { height:100%; margin:0; padding:0; }
    #map { position:absolute; top:0; right:0; bottom:0; left:200px; }
    #sidebar { position:absolute; top:0; left:0; width:200px; height:100%;
      background:#f7f7f7; padding:10px; box-shadow:2px 0 5px rgba(0,0,0,0.1); overflow-y:auto;
    }
    .filter-group { margin-bottom:15px; }
    .filter-group label { font-weight:bold; display:block; margin-bottom:5px; }
    .profile-icon img { border-radius:50%; width:40px; height:40px; object-fit:cover; border:2px solid #fff; }
    .leaflet-popup-content-wrapper { border-radius:20px; padding:8px; background:#fff; }
    .leaflet-popup-content { margin:0; text-align:center; }
    .popup-photo { width:80px; height:80px; border-radius:50%; object-fit:cover;
      display:block; margin:0 auto 8px;
    }
    .leaflet-popup-tip-container { width:0; height:0; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>Filters</h3>
    <div class="filter-group"><label for="minAge">Min Age</label><input id="minAge" type="number" value="18" min="18" max="100"/></div>
    <div class="filter-group"><label for="maxAge">Max Age</label><input id="maxAge" type="number" value="100" min="18" max="100"/></div>
    <div class="filter-group"><label for="maxDist">Max Distance (km)</label><input id="maxDist" type="number" value="100" min="0" max="100"/></div>
    <button id="applyFilters">Apply</button>
  </div>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script>
    const map=L.map('map').setView([48.86,2.33],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18, attribution:'&copy; OpenStreetMap'}).addTo(map);
    const cluster=L.markerClusterGroup();map.addLayer(cluster);
    fetch('profiles.geojson')
      .then(r=>r.json())
      .then(gj=>{
        const markers=gj.features.map(f=>{
          const [lon,lat]=f.geometry.coordinates;
          const { name, age, photoUrl }=f.properties;
          const icon=L.divIcon({
            html:`<div class='profile-icon'><img src='${photoUrl}'/></div>`,
            className:'',iconSize:[40,40],iconAnchor:[20,20],popupAnchor:[0,-20]
          });
          return L.marker([lat,lon],{icon}).bindPopup(`<img class='popup-photo' src='${photoUrl}'/><strong>${name}, ${age}</strong>`);
        });
        cluster.addLayers(markers);
      });
    document.getElementById('applyFilters').onclick=()=>{
      const minA=+document.getElementById('minAge').value;
      const maxA=+document.getElementById('maxAge').value;
      const maxD=+document.getElementById('maxDist').value;
      cluster.clearLayers();
      fetch('profiles.geojson').then(r=>r.json()).then(gj=>{
        const fm=gj.features.filter(f=>{const a=f.properties.age,d=f.properties.distance_km||0;return a>=minA&&a<=maxA&&d<=maxD;});
        const m=fm.map(f=>{
          const [lon,lat]=f.geometry.coordinates;
          const { name, age, photoUrl }=f.properties;
          const icon=L.divIcon({html:`<div class='profile-icon'><img src='${photoUrl}'/></div>`,className:'',iconSize:[40,40],iconAnchor:[20,20],popupAnchor:[0,-20]});
          return L.marker([lat,lon],{icon}).bindPopup(`<img class='popup-photo' src='${photoUrl}'/><strong>${name}, ${age}</strong>`);
        });
        cluster.addLayers(m);
      });
    };
  </script>
</body>
</html>